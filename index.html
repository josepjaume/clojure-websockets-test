<html>
  <head>
  <meta name="viewport" content="initial-scale=1, maximum-scale=1">
    <script type="text/javascript" src="http://code.jquery.com/jquery-2.1.1.js"></script>
    <style>
      *{
        box-sizing: border-box;
      }

      body, html{
        padding: 0px;
        margin: 0;
        height: 100%;
        width: 100%;
      }

      #controls{
        position: fixed;
        top: 10px;
        right: 10px;
        z-index: 100;
      }
    </style>
    <script type="text/javascript">
      var randColor = function(){
        return '#'+Math.floor(Math.random()*16777215).toString(16);
      }

      $(document).ready(function(){
        var openSocket = function(){
          return new WebSocket("ws://" + window.location.host + "/socket");
        };

        var socket = openSocket();

        var currentColor = randColor();

        setInterval(function(){
          if(socket.readyState == undefined || socket.readyState > 1){
            socket = openSocket();
          }
        }, 100);

        var clients = {};

        var getClient = function(clientId){
          var client = clients[clientId];
          if(client) return client;

          client = {
            id: clientId
          }

          clients[clientId] = client;
          return client;
        };

        var canvas = document.getElementById("canvas");

        resizeCanvas = function(){
          $(canvas).attr('height', $(document).height());
          $(canvas).attr('width', $(document).width());
        }

        resizeCanvas();
        $(window).resize(resizeCanvas);

        var context = canvas.getContext("2d");

        socket.onmessage = function(event){
          var data = JSON.parse(event.data);
          processEvent(data.id, data.data);
        }

        var processEvent = function(id, data){
          var client = getClient(id);
          var lastPosition = client.lastPosition;
          var position = data.position;

          if(data.drawing && lastPosition){
            context.beginPath();
            context.moveTo(lastPosition[0], lastPosition[1]);
            context.lineTo(position[0], position[1]);
            context.lineWidth = 10;
            context.lineCap = 'round';
            context.strokeStyle = data.color;
            context.stroke();
          }

          client.lastPosition = position;
        }

        var clicking = false;

        var processMouseEvent = function(event){
          if(!event.pageX|| !event.pageY) return;

          var data = {
            color: getColor(),
            position: [event.pageX, event.pageY],
            drawing: clicking
          };

          socket.send(JSON.stringify(data));
          processEvent("me", data);
        }

        socket.onopen = function(){
          $(document).mousedown(function(){ clicking = true; });
          $(document).mouseup(function(){ clicking = false; });
          $(document).mousemove(processMouseEvent);
          $(document).mousedown(processMouseEvent);

          $(window).on("touchstart", function(){ clicking = true });
          $(window).on("touchend", function(){ clicking = false });

          $(document).on("touchmove", function(event){
            var e = event.originalEvent;
            jQuery.each(e.targetTouches, function(index, evt){
              processMouseEvent(evt);
            });
            return false;
          });
        };

        var getColor = function(){
          if($("input#rainbow").is(':checked')){
            return randColor();
          }else{
            return currentColor;
          }
        };

        $("input#color").change(function(){
          currentColor = $("input#color").val();
        });
        $("input#color").val(currentColor);
      });
    </script>
  </head>
  <body>
    <canvas id="canvas"></canvas>
    <div id="controls">
      <input type="color" id="color">
      <input type="checkbox" id="rainbow" name="rainbow">
      <label for="rainbow">Rainbow</label>
    </div>
  </body>
</html>
<html>
  <head>
  <meta name="viewport" content="initial-scale=1, maximum-scale=1">
    <script type="text/javascript" src="http://code.jquery.com/jquery-2.1.1.js"></script>
    <style>
      body, html{
        padding: 0px;
        margin: 0;
        height: 100%;
        width: 100%;
      }

      #color{
        position: fixed;
        top: 10px;
        right: 10px;
        z-index: 100;
      }
    </style>
    <script type="text/javascript">
      $(document).ready(function(){
        var openSocket = function(){
          return new WebSocket("ws://" + window.location.host + "/socket");
        };

        var socket = openSocket();

        var currentColor = "#000";

        setInterval(function(){
          if(socket.readyState == undefined || socket.readyState > 1){
            socket = openSocket();
          }
        }, 100);

        var clients = {};

        var getClient = function(clientId){
          var client = clients[clientId];
          if(client) return client;

          client = {
            id: clientId
          }

          clients[clientId] = client;
          return client;
        };

        var canvas = document.getElementById("canvas");

        resizeCanvas = function(){
          $(canvas).attr('height', $(document).height());
          $(canvas).attr('width', $(document).width());
        }

        resizeCanvas();
        $(window).resize(resizeCanvas);

        var context = canvas.getContext("2d");

        socket.onmessage = function(event){
          var data = JSON.parse(event.data).data;
          processEvent(data);
        }

        var processEvent = function(data){
          var position = data.position;

          if(data.drawing){
            context.fillStyle = data.color;
            context.fillRect(position[0], position[1], 10, 10);
          }
        }

        socket.onopen = function(){
          var clicking = false;
          $(canvas).mousedown(function(){ clicking = true; });
          $(canvas).mouseup(function(){ clicking = false; });

          $(canvas).mousemove(function(event){
            if(!event.clientY || !event.clientX) return;

            var data = {
              color: currentColor,
              position: [event.clientX, event.clientY],
              drawing: clicking
            };

            socket.send(JSON.stringify(data));
            processEvent(data);
          });
        };

        $("input#color").change(function(){
          currentColor = $("input#color").val();
        });
      });
    </script>
  </head>
  <body>
    <canvas id="canvas"></canvas>
    <input type="color" id="color" name="color">
  </body>
</html>